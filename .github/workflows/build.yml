name: Build & Release

on:
  push:
    branches: [ "main" ]

permissions:
  contents: write

jobs:
  build-test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]
    steps:
      - uses: actions/checkout@v4
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x
      - name: Test
        run: dotnet test -c Release

  publish:
    runs-on: ${{ matrix.os }}
    needs: build-test
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            rid: win-x64
            ext: zip
          - os: ubuntu-latest
            rid: linux-x64
            ext: tar.gz
          - os: macos-latest
            rid: osx-x64
            ext: tar.gz
    steps:
      - uses: actions/checkout@v4
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x
      - name: Publish
        run: dotnet publish ModHearth.csproj -c Release -r ${{ matrix.rid }} --self-contained false /p:InformationalVersion=${{ github.run_number }} /p:MoveOutputDlls=false
      - name: Verify publish output (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          $publishDir = "bin\Release\net8.0\${{ matrix.rid }}\publish"
          if (-not (Test-Path $publishDir)) { throw "Publish directory not found: $publishDir" }
          $items = Get-ChildItem -Path $publishDir -Force
          if ($items.Count -eq 0) { throw "Publish directory is empty: $publishDir" }
          Get-ChildItem -Path $publishDir -Force | Format-Table -AutoSize
      - name: Verify publish output (Unix)
        if: matrix.os != 'windows-latest'
        run: |
          publish_dir="bin/Release/net8.0/${{ matrix.rid }}/publish"
          if [ ! -d "$publish_dir" ]; then
            echo "Publish directory not found: $publish_dir"
            exit 1
          fi
          if [ -z "$(ls -A "$publish_dir")" ]; then
            echo "Publish directory is empty: $publish_dir"
            exit 1
          fi
          ls -la "$publish_dir"
      - name: Package (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          New-Item -ItemType Directory -Path dist -Force | Out-Null
          $publishDir = "bin\Release\net8.0\${{ matrix.rid }}\publish"
          Compress-Archive -Path "$publishDir\*" -DestinationPath "dist\ModHearth-${{ matrix.rid }}.${{ matrix.ext }}" -Force
      - name: Package (Unix)
        if: matrix.os != 'windows-latest'
        run: |
          mkdir -p dist
          publish_dir="bin/Release/net8.0/${{ matrix.rid }}/publish"
          tar -czf "dist/ModHearth-${{ matrix.rid }}.${{ matrix.ext }}" -C "$publish_dir" .
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ModHearth-${{ matrix.rid }}
          path: dist/ModHearth-${{ matrix.rid }}.${{ matrix.ext }}

  release:
    runs-on: ubuntu-latest
    needs: publish
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true
      - name: List release artifacts
        run: ls -la dist
      - name: Create release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          tag: build-${{ github.run_number }}
          release_name: Build ${{ github.run_number }}
          body: ${{ github.sha }}
          file: dist/*
          file_glob: true
          overwrite: true
