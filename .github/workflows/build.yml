name: Build & Release

on:
  push:
    branches: [ "main" ]

permissions:
  contents: write

jobs:
  build-test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]
    steps:
      - uses: actions/checkout@v4
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x
      - name: Test (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb
          echo "Running UI tests under Xvfb (required for Skia smoke test)."
          if ! xvfb-run -a dotnet test -c Release; then
            echo "Tests failed. This can include the Skia native smoke test on Linux."
            exit 1
          fi
      - name: Test (Windows/macOS)
        if: matrix.os != 'ubuntu-latest'
        run: dotnet test -c Release

  compute-version:
    runs-on: ubuntu-latest
    needs: build-test
    if: ${{ needs.build-test.result == 'success' }}
    outputs:
      build_number: ${{ steps.compute.outputs.build_number }}
    steps:
      - name: Compute build number
        id: compute
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python - <<'PY'
          import json
          import os
          import re
          import urllib.request

          repo = os.environ.get("GITHUB_REPOSITORY")
          token = os.environ.get("GITHUB_TOKEN")
          url = f"https://api.github.com/repos/{repo}/releases/latest"
          headers = {"Accept": "application/vnd.github+json"}
          if token:
              headers["Authorization"] = f"Bearer {token}"
          req = urllib.request.Request(url, headers=headers)
          tag = ""
          try:
              with urllib.request.urlopen(req) as resp:
                  data = json.load(resp)
                  tag = data.get("tag_name") or ""
          except Exception:
              tag = ""
          match = re.match(r"build-(\\d+)", tag)
          build = int(match.group(1)) + 1 if match else 1
          print(f"Computed build number: {build}")
          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as handle:
              handle.write(f"build_number={build}\\n")
          PY

  publish:
    runs-on: ${{ matrix.os }}
    needs: compute-version
    if: ${{ needs.compute-version.result == 'success' }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            rid: win-x64
            ext: zip
          - os: ubuntu-latest
            rid: linux-x64
            ext: tar.gz
          - os: macos-latest
            rid: osx-x64
            ext: tar.gz
    steps:
      - uses: actions/checkout@v4
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x
      - name: Publish
        run: dotnet publish ModHearth.csproj -c Release -r ${{ matrix.rid }} --self-contained false /p:InformationalVersion=${{ needs.compute-version.outputs.build_number }} /p:MoveOutputDlls=false
      - name: Verify publish output (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          $publishDir = "bin\Release\net8.0\${{ matrix.rid }}\publish"
          if (-not (Test-Path $publishDir)) { throw "Publish directory not found: $publishDir" }
          $items = Get-ChildItem -Path $publishDir -Force
          if ($items.Count -eq 0) { throw "Publish directory is empty: $publishDir" }
          Get-ChildItem -Path $publishDir -Force | Format-Table -AutoSize
      - name: Verify publish output (Unix)
        if: matrix.os != 'windows-latest'
        run: |
          publish_dir="bin/Release/net8.0/${{ matrix.rid }}/publish"
          if [ ! -d "$publish_dir" ]; then
            echo "Publish directory not found: $publish_dir"
            exit 1
          fi
          if [ -z "$(ls -A "$publish_dir")" ]; then
            echo "Publish directory is empty: $publish_dir"
            exit 1
          fi
          ls -la "$publish_dir"
      - name: Package (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          New-Item -ItemType Directory -Path dist -Force | Out-Null
          $publishDir = "bin\Release\net8.0\${{ matrix.rid }}\publish"
          Compress-Archive -Path "$publishDir\*" -DestinationPath "dist\ModHearth-${{ matrix.rid }}.${{ matrix.ext }}" -Force
      - name: Package (Unix)
        if: matrix.os != 'windows-latest'
        run: |
          mkdir -p dist
          publish_dir="bin/Release/net8.0/${{ matrix.rid }}/publish"
          tar -czf "dist/ModHearth-${{ matrix.rid }}.${{ matrix.ext }}" -C "$publish_dir" .
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ModHearth-${{ matrix.rid }}
          path: dist/ModHearth-${{ matrix.rid }}.${{ matrix.ext }}

  release:
    runs-on: ubuntu-latest
    needs: [build-test, compute-version, publish]
    if: ${{ needs.build-test.result == 'success' && needs.publish.result == 'success' && needs.compute-version.result == 'success' }}
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true
      - name: List release artifacts
        run: ls -la dist
      - name: Create release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          tag: build-${{ needs.compute-version.outputs.build_number }}
          release_name: Build ${{ needs.compute-version.outputs.build_number }}
          body: ${{ github.sha }}
          file: dist/*
          file_glob: true
          overwrite: true

  release-status:
    runs-on: ubuntu-latest
    needs: [build-test, compute-version, publish, release]
    if: ${{ always() }}
    steps:
      - name: Report release status
        run: |
          if [ "${{ needs.build-test.result }}" != "success" ]; then
            echo "Release skipped because tests failed."
            exit 0
          fi
          if [ "${{ needs.compute-version.result }}" != "success" ]; then
            echo "Release skipped because build number could not be computed."
            exit 0
          fi
          if [ "${{ needs.publish.result }}" != "success" ]; then
            echo "Release skipped because publish failed."
            exit 0
          fi
          if [ "${{ needs.release.result }}" != "success" ]; then
            echo "Release did not complete successfully."
            exit 1
          fi
          echo "Release completed successfully."
